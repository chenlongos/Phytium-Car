# 任务二：PCIe 主桥枚举设备，发现 USB 3.0 主机控制器

PCIe 主桥枚举连接到总线上的设备，发现 USB 3.0 主机控制器设备

* 执行 PCIe 总线扫描以检测连接到总线上的所有设备。通常通过读取配置空间中的特定寄存器来实现。
* 对于检测到的设备，需要解析其配置空间以获取设备的厂商 ID、设备 ID、类别码等重要信息。
* USB 3.0 主机控制器设备的类别码通常是 0x0C（Serial bus controller）。

## 枚举并记录已连接设备

1. 初始化根端口：PCIe桥首先会初始化其自身作为根端口，将其配置为根端口的相关寄存器。

2. 遍历子端口：PCIe桥会依次访问其下方的子端口。这些子端口可以是其他PCIe桥或直接连接的PCI设备。

3. 检测链接状态：对于每个子端口，PCIe桥会检测其链路状态，以确定是否有设备连接到该端口上。

4. 链接重播（Link Retraining）：如果有设备连接到子端口上，并且链路状态正常，则PCIe桥可能会执行链接重播操作，以确保链路稳定和可靠。

5. 记录已连接设备：当PCIe桥确定子端口连接了一个PCI设备时，它会记录该设备的信息，如设备ID、厂商ID等。

6. 递归遍历：如果子端口连接的是另一个PCIe桥，那么PCIe桥会递归地遍历该子桥的子端口，以继续检测更深层次的PCI设备。


## 获取设备配置信息

PCIe桥针对每个连接的PCIe端口，使用PCI Express Configuration Space来进一步扫描和识别连接的PCI设备。PCI Express Configuration Space是一种特殊的寄存器空间，包含了与PCIe设备相关的配置信息，如设备ID、厂商ID、类别代码等。

以树莓派为例，对于连接在PCIe的 xhci 主机控制器，参考 [VL805 芯片手册](https://github.com/chenlongos/raspi4-with-arceos-doc/blob/master/src/assert/DS_VLI_VL805_093.pdf)，可以知晓其配置空间

### PCI配置寄存器介绍

#### Header Registers (00-3Fh)

* Offset Address : 01-00h

  Vendor ID（默认1106h）

  | Bit（位） | 状态 |  值   |             介绍              |
  | :-------: | :--: | :---: | :---------------------------: |
  |   15：0   | 只读 | 1106h | VIA Technology 的ID（厂商ID） |

* Offset Address : 03-02h

  Device ID （默认3483h）

  | Bit（位） | 状态 |  值   |  介绍  |
  | :-------: | :--: | :---: | :----: |
  |   15：0   | 只读 | 3483h | 设备ID |

* Offset Address : 05-04h

  PCI Command（默认0000h）

  | Bit（位） | 状态 |  值  |          介绍          |
  | :-------: | :--: | :--: | :--------------------: |
  |  15：11   | 只读 |  0   |          保留          |
  |    10     | 读写 |  0   |        中断禁用        |
  |     9     | 只读 |  0   |          保留          |
  |     8     | 读写 |  0   |        SERR启用        |
  |     7     | 只读 |  0   |          保留          |
  |     6     | 读写 |  0   |   奇偶校验错误的响应   |
  |     5     | 只读 |  0   |          保留          |
  |     4     | 只读 |  0   | 内存写入和使失效的状态 |
  |     3     | 只读 |  0   |          保留          |
  |     2     | 读写 |  0   |        总线主控        |
  |     1     | 读写 |  0   |        内存空间        |
  |     0     | 读写 |  0   |        I/O空间         |

* Offset Address : 07-06h

  PCI Status （默认0010h）

  | Bit（位） |  状态   |  值  |                         介绍                         |
  | :-------: | :-----: | :--: | :--------------------------------------------------: |
  |    15     | 写1清零 |  0   |                是否检测到奇偶校验错误                |
  |    14     | 写1清零 |  0   |                   是否发生系统错误                   |
  |    13     | 写1清零 |  0   |                是否接收到主控中止信号                |
  |    12     | 写1清零 |  0   |                是否接收到目标中止信号                |
  |    11     | 写1清零 |  0   |                  是否发生了目标中止                  |
  |   10：9   |  只读   |  0   |                  设备选择信号的时序                  |
  |     8     | 写1清零 |  0   |            是否检测到主数据的奇偶校验错误            |
  |   7：4    |  只读   | 01h  | 用于 PCI-PMI 功能（电源管理机制，支持 PCI-PMI 中断） |
  |     3     |  只读   |  0   |                       中断状态                       |
  |   2：0    |  只读   |  0   |                         保留                         |

* Offset Address : 08h

  Revision ID（默认为01h）

  | Bit（位） | 状态 |  值  |        介绍        |
  | :-------: | :--: | :--: | :----------------: |
  |   7：0    | 只读 | 00h  | 硬件的版本或修订号 |

* Offset Address : 0B-09h

  Class Code（默认0C0330h）

  | Bit（位） | 状态 |   值    |         介绍         |
  | :-------: | :--: | :-----: | :------------------: |
  |   23：0   | 只读 | 0C0330h | 主机控制器的类别代码 |

  - **主类别：** 0Ch 表示 USB 控制器（USB Controllers）。
  - **子类别：** 03h 表示 USB 3.0 控制器（USB 3.0 Controller）。
  - **接口：** 30h 表示 XHCI（eXtensible Host Controller Interface）

* Offset Address : 0Ch

  Cache Line Size（默认00h）

  | Bit（位） | 状态 |  值  |    介绍    |
  | :-------: | :--: | :--: | :--------: |
  |   7：0    | 读写 |  0   | 缓存行大小 |

* Offset Address : 0Dh

  Latency Timer（默认00h）

  | Bit（位） | 状态 |  值  |    介绍    |
  | :-------: | :--: | :--: | :--------: |
  |   7：0    | 只读 |  0   | 延迟计时器 |

* Offset Address : 0Eh

  Header Type（默认00h）

  | Bit（位） | 状态 |  值  |   介绍   |
  | :---------: | :--: | :--: | :------: |
  |    7：0     | 只读 | 00h  | 头部类型 |

* Offset Address : 0Fh

  Built In Self Test (BIST)（默认00h）

  | Bit（位） | 状态 |  值  | 介绍 |
  | :---------: | :--: | :--: | :--: |
  |    7：0     | 只读 |  0   | 自检 |

* Offset Address : 13-10h

  XHCI Memory Mapped I/O Low Base Address（默认0000_0004h）

  | Bit（位） | 状态 |  值  |                             介绍                             |
  | :---------: | :--: | :--: | :----------------------------------------------------------: |
  |   31：12    | 读写 |  0   | XHCI 内存映射 I/O 寄存器的低基地址<br />USB 3.0 XHCI MMIO 寄存器基址的内存地址 |
  |    11：3    | 只读 |  0   |                             保留                             |
  |    2：1     | 只读 | 10b  |    基址的寻址类型<br />值为"10b"时，基址的寻址模式为64位     |
  |      0      | 只读 |  0   |                             保留                             |

* Offset Address : 17-14h

  XHCI Memory Mapped I/O High Base Address（默认0000_0000h）

  | Bit（位） | 状态 |  值  |                             介绍                             |
  | :---------: | :--: | :--: | :----------------------------------------------------------: |
  |    31：0    | 读写 |  0   | XHCI 内存映射 I/O 寄存器的高基地址<br />USB 3.0 XHCI MMIO 寄存器基址的内存地址 |

* Offset Address : 18-2Bh（保留）

* Offset Address : 2D-2C

  Subsystem Vendor ID（默认1106h）

  | Bit（位） | 状态 |  值   |      介绍      |
  | :---------: | :--: | :---: | :------------: |
  |    15：0    | 读写 | 1106h | 子系统供应商ID |

* Offset Address : 2F-2E

  Subsystem ID（默认3483h）

  | Bit（位） | 状态 |  值   |   介绍   |
  | :---------: | :--: | :---: | :------: |
  |    15：0    | 读写 | 3483h | 子系统ID |

* Offset Address : 30-33h（保留）

* Offset Address : 34h

  Capability Pointer（默认80h）

  | Bit（位） | 状态 |  值  |                          介绍                           |
  | :---------: | :--: | :--: | :-----------------------------------------------------: |
  |    7：0     | 只读 | 80h  | 能力指针<br />指向配置空间中某个特定功能的偏移地址 0x80 |

* Offset Address : 35-3Bh（保留）

* Offset Address : 3Ch

  Interrupt Line（默认00h）

  | Bit（位） | 状态 |  值  |     介绍     |
  | :---------: | :--: | :--: | :----------: |
  |    7：0     | 读写 |  0   | 中断线路配置 |

* Offset Address : 3Dh

  Interrupt Pin（默认01h）

  | Bit（位） | 状态 |  值  |                    介绍                     |
  | :---------: | :--: | :--: | :-----------------------------------------: |
  |    7：0     | 只读 | 01h  | 中断引脚<br />01h表示中断引脚被设置为 INTA# |

* Offset Address : 3E-3Fh（保留）


#### XHCI-Specific Configuration Registers (40-FFh)

* Offset Address : 40-43h（保留）

* Offset Address : 48-4Bh

  XHCI CRCR Mirror Low Register（默认0000_0000h）

  | Bit（位） | 状态 |  值  |                         介绍                         |
  | :-------: | :--: | :--: | :--------------------------------------------------: |
  |   31：0   | 只读 |  0   | USB 3.0 控制器（XHCI）中的 CRCR 镜像寄存器的低位部分 |

  - **CRCR**: 表示 Command Ring Control Register，即命令环的控制寄存器。
  - **Mirror Low Register**: 表示这是一个镜像寄存器，可能用于备份或者同步控制信息。

* Offset Address : 4C-4Fh（保留）

* Offset Address : 50-53h

  XHCI MCU Firmware Version （默认0000_0000h）

  | Bit（位） | 状态 |  值  |         介绍         |
  | :-------: | :--: | :--: | :------------------: |
  |   31：0   | 只读 |  0   | XHCI控制器的固件版本 |

* Offset Address : 5C-5Dh

  Subsystem Vendor ID For SW （默认为1106h）

  | Bit（位） | 状态 |  值   |             介绍              |
  | :-------: | :--: | :---: | :---------------------------: |
  |   15：0   | 读写 | 1106h | 子系统供应商 ID（软件可更新） |

* Offset Address : 5E-5Fh

  Class Code（默认3483h）

  | Bit（位） | 状态 |  值   |          介绍           |
  | :-------: | :--: | :---: | :---------------------: |
  |   15：0   | 读写 | 3483h | 子系统 ID（软件可更新） |

* Offset Address : 60h

  Serial Bus Release Number (SBRN)（默认30h）

  | Bit（位） | 状态 |  值  |          介绍          |
  | :-------: | :--: | :--: | :--------------------: |
  |   7：0    | 只读 | 30h  | 串行总线规范发布版本号 |

* Offset Address : 61h

  Frame Length Adjustment (FLADJ) （默认20h）

  | Bit（位） | 状态 |  值  |                     介绍                      |
  | :-------: | :--: | :--: | :-------------------------------------------: |
  |   7：6    | ROS  |  0   |                     保留                      |
  |   5：0    | RWS  | 20h  | 帧长度定时值<br />为20h时，SOF循环时间为60000 |

* Offset Address : 78-7Bh

  XHCI Optional Bits Configuration Address（默认0000_0000h）

  | Bit（位） | 状态 |  值  |        介绍         |
  | :-------: | :--: | :--: | :-----------------: |
  |  31：20   | 只读 |  0   |        保留         |
  |   19：0   | 读写 |  0   | XHCI 选项位配置地址 |

  * XHCI Option Bits Configuration Address是一个特定的寄存器地址，用于访问 XHCI 控制器中的选项位配置。通过写入或读取该地址上的寄存器，可以对 XHCI 控制器进行参数设置和功能调整。

* Offset Address : 7C-7Fh

  XHCI Optional Bits Configuration Data （默认0000_0000h）

  | Bit（位） | 状态 |  值  |        介绍         |
  | :-------: | :--: | :--: | :-----------------: |
  |   31：0   | 读写 |  0   | XHCI 选项位配置数据 |

* Offset Address : 80h

  Power Management Capability ID（默认01h）

  | Bit（位） | 状态 |  值  |      介绍      |
  | :-------: | :--: | :--: | :------------: |
  |   7：0    | ROS  | 01h  | 功耗管理能力ID |

* Offset Address : 81h

  Next Item Pointer 1（默认90h）

  | Bit（位） | 状态 |  值  |        介绍         |
  | :-------: | :--: | :--: | :-----------------: |
  |   7：0    | ROS  | 90h  | 指向下个项目的指针1 |

* Offset Address : 82-83h

  Power Management Capability （默认4083h）

  | Bit（位） | 状态 |  值   |     介绍     |
  | :-------: | :--: | :---: | :----------: |
  |   15：0   | ROS  | 4083h | 功耗管理能力 |

  * 功耗管理是一种重要的技术，旨在降低设备的功耗，提高能效，并延长电池寿命。功耗管理能力可以包括各种功能和策略，如睡眠模式、节能模式、动态频率调整、电源管理协议等。

* Offset Address : 84-85h

  Power Management Capability Control / Status（默认0000h）

  | Bit（位） | 状态 |  值  |                            介绍                            |
  | :-------: | :--: | :--: | :--------------------------------------------------------: |
  |    15     | RWS  |  0   |            PME 状态<br />0：非激活     1：激活             |
  |   14：9   | ROS  |  0   |                            保留                            |
  |     8     | RWS  |  0   |             PME 使能<br />0：禁用     1：启用              |
  |   7：2    | ROS  |  0   |                            保留                            |
  |   1：0    | RWS  | 00b  | 电源状态<br />00：D0     01：D1<br />10：D2     11：D3 Hot |

  * D0：表示设备处于全功耗状态，即正常操作状态。
  * D1：表示设备进入了低功耗状态，是功率最高的设备低功耗状态。
  * D2：表示设备进入了低功耗状态，消耗量小于或等于 D1 状态下的消耗量。
  * D3 Hot：表示功率最低的设备低功耗状态。

* Offset Address : 86-8Fh（保留）

* Offset Address : 90h

  MSI Capability ID（默认05h）

  | Bit（字节） | 状态 |  值  |     介绍      |
  | :---------: | :--: | :--: | :-----------: |
  |    7：0     | 只读 | 05h  | MSI中断能力ID |

  * 在 PCI 配置空间中，每个 Capability 都有一个 Capability ID 字段。对于 MSI Capability，其 Capability ID 通常为 0x05。

* Offset Address : 91h

  Next Item Pointer 2（默认C4h）

  | Bit（位） | 状态 |  值  |        介绍         |
  | :-------: | :--: | :--: | :-----------------: |
  |   7：0    | 只读 | C4h  | 指向下一个项目指针2 |

* Offset Address : 92-93h

  MSI Message Control（默认0084h）

  | Bit（位） | 状态 |  值  |                             介绍                             |
  | :-------: | :--: | :--: | :----------------------------------------------------------: |
  |   15：9   | 只读 |  0   |                             保留                             |
  |     8     | 只读 |  0   |          每向量屏蔽能力<br />1：支持     2：不支持           |
  |     7     | 只读 |  1b  |       64位地址功能支持能力<br />1：支持     2：不支持        |
  |   6：4    | 读写 |  0   | 分配的中断向量数量<br />000：1     001：2<br />010：4     011：8<br />100：16     101：32<br />110：保留     111：保留 |
  |   3：1    | 只读 | 010b | 请求的中断向量数量<br />000：1     001：2<br />010：4     011：8<br />100：16     101：32<br />110：保留     111：保留 |
  |     0     | 读写 |  0   |                           MSI使能                            |

* Offset Address : 94-97h

  MSI Message Address Low（默认0000_0000h）

  | Bit（位） | 状态 |  值  |                    介绍                    |
  | :-------: | :--: | :--: | :----------------------------------------: |
  |   31：2   | 读写 |  0   | MSI 消息地址的低32位<br />系统指定消息地址 |
  |   1：0    | 只读 |  0   |                    保留                    |

* Offset Address : 98-9Bh

  MSI Message Address High （默认0000_0000h）

  | Bit（位） | 状态 |  值  |                    介绍                    |
  | :-------: | :--: | :--: | :----------------------------------------: |
  |   31：0   | 读写 |  0   | MSI 消息地址的高32位<br />系统指定消息地址 |

* Offset Address : 9C-9Dh

  MSI Data（默认0000h）

  | Bit（位） | 状态 |  值  |     介绍     |
  | :-------: | :--: | :--: | :----------: |
  |   15：0   | 读写 |  0   | MSI 消息数据 |

* Offset Address : 9E-FFh（保留）


  
### 具体实例（树莓派Linux系统）

输入`lspci`可以查看到关于pci的信息，得到如下输出：

```shell
pi@yahboom:~$ lspci
00:00.0 PCI bridge: Broadcom Inc. and subsidiaries BCM2711 PCIe Bridge (rev 20)
01:00.0 USB controller: VIA Technologies, Inc. VL805 USB 3.0 Host Controller (rev 01)
```

可以看到第一条为PCI主桥，第二条为连接在主桥的PCI设备，即 USB 3.0 主机控制器

在输入`sudo lspci -xxxxx -s 01:00.0`可以查看关于 USB 3.0 主机控制器的寄存器信息，得到如下输出：

```shell
pi@yahboom:~$ sudo lspci -xxxxx -s 01:00.0
01:00.0 USB controller: VIA Technologies, Inc. VL805 USB 3.0 Host Controller (rev 01)
00: 06 11 83 34 46 05 10 00 01 30 03 0c 10 00 00 00
10: 04 00 00 c0 00 00 00 00 00 00 00 00 00 00 00 00
20: 00 00 00 00 00 00 00 00 00 00 00 00 06 11 83 34
30: 00 00 00 00 80 00 00 00 00 00 00 00 24 01 00 00
40: 00 00 00 00 00 01 00 00 09 70 97 f0 04 00 00 00
50: c0 38 01 00 00 00 00 00 00 00 00 00 06 11 83 34
60: 30 20 00 00 00 00 00 00 00 00 00 00 00 00 00 00
70: 00 00 00 00 00 00 00 00 08 00 03 00 01 00 00 18
80: 01 90 c3 89 00 00 00 00 00 00 00 00 00 00 00 00
90: 05 c4 85 00 fc ff ff ff 00 00 00 00 40 65 00 00
```

由上述关于寄存器的介绍可知，

* Header Registers (00-3Fh)
  * 偏移量为00：0x3483_1106，表示厂商ID为0x3483和设备ID为0x1106
  * 偏移量为04：0x100546，启用内存空间，启用总线主控，禁用I/O空间，启用奇偶校验错误的响应，启用SERR（系统错误），启用中断，启用PCI-PMI 功能
  * 偏移量为08：0xc033001，表示 USB3.0 XHCI 主机控制器，硬件版本为1
  * 偏移量为0c：0x1，表示缓存行大小为1
  * 偏移量为10：0xc000_0004，表示基址的寻址模式为64位，XHCI 内存映射 I/O 寄存器的低基地址为0xC_0000
  * 偏移量为14：0x0，表示XHCI 内存映射 I/O 寄存器的高基地址为0x0000_0000
  * 偏移量为2c：0x3483_1106，表示子系统供应商ID为0x3483和子系统ID为0x1106
  * 偏移量为34：0x80，表示第一个能力结构可以在设备配置空间的偏移地址0x80处
  * 偏移量为3c：0x124，表示禁用 USB 中断

* XHCI-Specific Configuration Registers (40-FFh)
  * 偏移量为48：0xf097_7009，表示 USB 3.0 控制器（XHCI）中的 CRCR 镜像寄存器的低位部分为0xf097_7009
  * 偏移量为50：0x138c0，表示 XHCI 控制器的固件版本为0x138c0
  * 偏移量为5c：0x3483_1106，表示子系统供应商ID为0x3483和子系统ID为0x1106
  * 偏移量为60：0x2030，0x30表示串行总线规范发布版本号，0x20表示SOF循环时间为60000
  * 偏移量为78：0x30008，表示 XHCI 选项位配置地址为0x0003_0008
  * 偏移量为7c：0x1800_0001，表示 XHCI 选项位配置数据为0x1800_0001
  * 偏移量为80：0x89c3_9001，0x01表示功耗管理能力ID，0x90表示指向下个项目的指针，0x89c3-->?
  * 偏移量为84：0x0，表示电源状态为 D0，即全功耗状态，禁用 PME 使能，不激活 PME 状态
  * 偏移量为90：0x85c405，0x05表示 MSI 中断能力ID为0x05；0xc4表示指向下一个项目的指针；0x85表示 MSI 使能，请求的中断向量数量为4，支持64位地址功能
  * 偏移量为94：0xffff_fffc，表示 MSI 消息地址的低32位为0xffff_fffc
  * 偏移量为98：0x0，表示 MSI 消息地址的高32位为0x0000_0000
  * 偏移量为9c：0x6540，表示系统指定的消息数据为0x6540
 

### 代码实现

```rust

```



