本章将介绍USB设备插入机器后到接受到数据这个过程中驱动协议的流程
----
USB 介绍
=====
 USB（通用串行总线）是一个外部总线标准，规范电脑与外部设备的连接和通讯，其内部只有4根线，两根电源线两根信号线。USB支持热插拔。  
 （机器在运行中插入usb设备可以直接与该设备通信，无需将电脑重启）

USB的发展历程从USB 1.0开始，到后面的USB1.1，USB 2.0，USB 3.0，USB 3.1，USB 3.2，直到USB 4.0，不断提升了数据传输速度和设备兼容性，广泛应用于各种电子设备中。

>在arceos上的USB驱动代码中,我们使用rust编写XHCI和USB的协议驱动，大致流程如下

# 流程图



```
在学习前，请你查阅USB中文网，参考XHCI规范手册等方法，了解在USB驱动中，端点，，端口，接口，槽位这些名词的含义
```  
## 下面是USB驱动流程的具体介绍  
### *要实现USB设备能与主机之间进行基本的数据传输，需要先初始化XHCI控制器*

### *XHCI是一种可扩展的用于管理 USB 设备的主控制器接口标准。比如电脑上的那些USB插槽。*

## 第一部分  
首先看向apps/usb/src/main.rs这里的第36行，我们参考飞腾派官方提供的信息，选择第一个XHCI控制器，其地址为0x31a0_8000,在这里我们加上了虚拟地址的前缀：0xffff_0000,但是由于arceos在映射mmio区域时，采取的是1：1映射，因此这个地址仍然指向0x31a0_8000，同时事实上我们也可以直接访问0x31a0_8000来访问控制器。  
（同时定义了48为中断号，优先级0，）

通过访问XHCI控制器寄存器，获取到如最大槽位数，最大端口数这些信息，与xhci地址连载一起放入xhci对象中，调用init进行xhci的初始化，这个 init 函数位于xhci目录下mod.rs文件中的第357行，流程大致如下：  
### 1.	硬件复位
### 2.	设置最大设备槽数
### 3.	设置设备上下文基地址数组指针
### 4.	设置命令环
### 5.	初始化中断
### 6.	配置暂存缓冲区
### 7.	启动控制器
### 8.	测试命令
### 9.	重置端口
### 10.	返回结果  

>**这些函数位于XHCI目录下的mod.rs文件中**

## 第二部分  

#### 完成了XHCI控制器的配置之后，接着就是具体到USB设备的驱动协议了  
看向apps/usb/src/main.rs这里的第49行，这里调用了xhci目录下mod.rs文件中127行的poll函数，  
首先通过访问regs寄存器，遍历电脑上所有的端口，将启用的端口 ID 添加到 port_id_list 向量中。  
遍历所有启用的端口，给这些设备进行一些基本的初始化：  
### 1，
将设备地址到 USB 控制器的上下文中，在 USB 控制器中设置设备的上下文信息，以便控制器能够正确识别和管理设备。  
### 2，
分配端点0的包大小：端点0是USB设备的默认控制端点，用于控制传输通信的端点  
### 3，
遍历设备描述符和配置描述符，将描述符中的部分信息储存在device对象中  
### 4，
给每个设备配置端点信息，确保接下来用于通信的端点处于启用状态  
### 5，
将device对象放入device_list，返回包含所有发现设备的 device_list。  

## 第三部分
**接下来，我们看向xhci_device.rs文件中349行的test_hid_mouse函数**  

### 通过发送控制传输请求，来对设备进行设备配置和接口配置
>作用是初始化设备的配置状态，以及让设备选择合适的接口工作

### 通过发送控制传输请求，来对设备设置协议。设置空闲率
>作用是选择合适的协议通信，设置设备发送事件的频率

### 通过发送控制传输请求，获取设备的报告描述符
>作用是接收返回来的报告数据，解析其中的报告内容  

```
前面都是发送控制传输请求，不同点在于前面的设备配置，接口配置，设置协议，设置空闲率，这些是为了确保后期主机能正常接收到鼠标事件做好的配置，没有事件返回，所以是使用的是control_transfer_out函数，方向是out，指数据从主机到鼠标

后面获取报告描述符是鼠标向主机返回事件数据，所以使用control_transfer_in函数.
```
```
由于鼠标键盘之类的HID设备，数据是等到设备有行为，才会有事件数据返回，所以是用中断传输返回事件。
```

### 最后在loop中发送中断传输请求，对返回的具体鼠标行为事件进行数据处理
